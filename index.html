<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANNAMALAIYAR FINANCE ‡´ê ìâ∏ìÜò</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 10px;
            background-color: #f5f7fa;
            color: #333;
            font-size: 14px;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        h1 {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        h2 {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .form-group {
            margin-bottom: 10px;
        }
        label {
            display: block;
            margin-bottom: 3px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 5px 5px 5px 0;
            white-space: nowrap;
        }
        button.delete-btn {
            background: #e74c3c;
        }
        button.print-btn {
            background: #2ecc71;
        }
        button:hover {
            opacity: 0.9;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.8rem;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #3498db;
            color: white;
            position: sticky;
            top: 0;
            font-size: 0.8rem;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .search-container {
            margin-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .search-container input {
            flex: 1;
            min-width: 150px;
        }
        .total-summary {
            background: #e8f4fc;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        .message {
            font-size: 0.8rem;
            margin-top: 5px;
            padding: 5px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        .modal-content {
            background: white;
            padding: 15px;
            border-radius: 5px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow: auto;
        }
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }
        .nowrap {
            white-space: nowrap;
        }
        .balance {
            color: #e74c3c;
            font-weight: bold;
        }
        .customer-image {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #3498db;
        }
        .customer-image-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #3498db;
            margin: 5px 0;
            display: none;
        }
        .signature-preview {
            width: 120px;
            height: 40px;
            border: 1px solid #ddd;
            margin: 5px 0;
            display: none;
        }
        .tab-container {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 10px;
        }
        .tab {
            padding: 8px 15px;
            cursor: pointer;
            background: #f1f1f1;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            font-size: 0.9rem;
        }
        .tab.active {
            background: #3498db;
            color: white;
        }
        
        /* Print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #printSection, #printSection * {
                visibility: visible;
            }
            #printSection {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 10px;
                background: white;
                margin: 0;
                font-size: 12px;
            }
            .no-print {
                display: none !important;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            th, td {
                border: 1px solid #ddd;
                padding: 5px;
            }
            th {
                background-color: #3498db !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            @page {
                size: A4;
                margin: 5mm;
            }
            .page-number:after {
                content: counter(page);
            }
            .print-footer {
                position: fixed;
                bottom: 0;
                width: 100%;
                text-align: center;
                font-size: 8px;
                padding: 5px;
            }
            .print-image {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                object-fit: cover;
                border: 2px solid #3498db;
            }
            .print-signature {
                width: 100px;
                height: 40px;
                margin-top: 5px;
                border: 1px solid #000;
            }
            .signature-line {
                border-top: 1px solid #000;
                width: 100px;
                margin-top: 30px;
            }
            .signature-container {
                margin-top: 20px;
                display: flex;
                justify-content: space-between;
            }
            .signature-box {
                text-align: center;
                width: 45%;
            }
            .signature-title {
                margin-top: 3px;
                font-weight: bold;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ANNAMALAIYAR FINANCE ‡´ê ìâ∏ìÜò</h1>
        
        <div class="tab-container">
            <div class="tab active" onclick="showTab('customerTab')">‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç</div>
            <div class="tab" onclick="showTab('paymentTab')">‡Æ™‡Æ£‡ÆÆ‡Øç ‡Æö‡ØÜ‡Æ≤‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ</div>
            <div class="tab" onclick="showTab('recordsTab')">‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç</div>
        </div>
        
        <div id="customerTab" class="tab-content">
            <div class="section">
                <h2>‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï</h2>
                <form id="customerForm">
                    <div class="form-group">
                        <label for="customerName">‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç</label>
                        <input type="text" id="customerName" required>
                    </div>
                    <div class="form-group">
                        <label for="phoneNumber">‡Æ§‡Øä‡Æ≤‡Øà‡Æ™‡Øá‡Æö‡Æø ‡Æé‡Æ£‡Øç</label>
                        <input type="text" id="phoneNumber" pattern="[0-9]{10}" title="10 digit phone number">
                    </div>
                    <div class="form-group">
                        <label for="aadharNumber">‡ÆÜ‡Æ§‡Ææ‡Æ∞‡Øç ‡Æé‡Æ£‡Øç</label>
                        <input type="text" id="aadharNumber" pattern="[0-9]{12}" title="12 digit Aadhar number">
                    </div>
                    <div class="form-group">
                        <label for="principalAmount">‡ÆÖ‡Æö‡Æ≤‡Øç ‡Æ§‡Øä‡Æï‡Øà (‚Çπ)</label>
                        <input type="number" id="principalAmount" required min="1">
                    </div>
                    <div class="form-group">
                        <label for="interestRate">‡Æµ‡Æü‡Øç‡Æü‡Æø ‡Æµ‡Æø‡Æï‡Æø‡Æ§‡ÆÆ‡Øç (%)</label>
                        <input type="number" id="interestRate" value="3" required min="0" max="100" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="startDate">‡Æ§‡Øä‡Æü‡Æï‡Øç‡Æï ‡Æ§‡Øá‡Æ§‡Æø</label>
                        <input type="date" id="startDate" required>
                    </div>
                    <div class="form-group">
                        <label for="customerImage">‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç ‡Æ™‡Æü‡ÆÆ‡Øç</label>
                        <input type="file" id="customerImage" accept="image/*">
                        <img id="customerImagePreview" class="customer-image-preview" alt="Customer Image Preview">
                    </div>
                    <div class="form-group">
                        <label for="customerSignature">‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç ‡Æï‡Øà‡ÆØ‡Øä‡Æ™‡Øç‡Æ™‡ÆÆ‡Øç</label>
                        <input type="file" id="customerSignature" accept="image/*">
                        <img id="customerSignaturePreview" class="signature-preview" alt="Customer Signature Preview">
                    </div>
                    <div class="form-group">
                        <label for="ownerSignature">‡Æâ‡Æ∞‡Æø‡ÆÆ‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç ‡Æï‡Øà‡ÆØ‡Øä‡Æ™‡Øç‡Æ™‡ÆÆ‡Øç</label>
                        <input type="file" id="ownerSignature" accept="image/*">
                        <img id="ownerSignaturePreview" class="signature-preview" alt="Owner Signature Preview">
                    </div>
                    <button type="submit">‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øà ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï</button>
                    <div id="formMessage" class="message" style="display:none;"></div>
                </form>
            </div>
        </div>
        
        <div id="paymentTab" class="tab-content" style="display:none;">
            <div class="section">
                <h2>‡Æµ‡Æü‡Øç‡Æü‡Æø ‡Æ™‡Æ£‡ÆÆ‡Øç ‡Æ™‡ØÜ‡Æ±‡ØÅ‡Æ§‡Æ≤‡Øç</h2>
                <form id="paymentForm">
                    <div class="form-group">
                        <label for="customerSelect">‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øà ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç</label>
                        <select id="customerSelect" required>
                            <option value="">-- ‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øà ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="paymentDate">‡Æ™‡Æ£‡ÆÆ‡Øç ‡Æ™‡ØÜ‡Æ±‡ØÅ‡ÆÆ‡Øç ‡Æ§‡Øá‡Æ§‡Æø</label>
                        <input type="date" id="paymentDate" required>
                    </div>
                    <div class="form-group">
                        <label for="dueAmount">‡Æµ‡Æü‡Øç‡Æü‡Æø ‡Æ§‡Øä‡Æï‡Øà (‚Çπ)</label>
                        <input type="number" id="dueAmount" readonly>
                    </div>
                    <div class="form-group">
                        <label for="paidAmount">‡Æ™‡ØÜ‡Æ±‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æ§‡Øä‡Æï‡Øà (‚Çπ)</label>
                        <input type="number" id="paidAmount" required min="1">
                    </div>
                    <div class="form-group">
                        <label for="balanceAmount">‡ÆÆ‡ØÄ‡Æ§‡Æø ‡Æ§‡Øä‡Æï‡Øà (‚Çπ)</label>
                        <input type="number" id="balanceAmount" readonly>
                    </div>
                    <div class="form-group">
                        <label for="paymentNotes">‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç</label>
                        <input type="text" id="paymentNotes">
                    </div>
                    <button type="submit">‡Æ™‡Æ£‡Æ§‡Øç‡Æ§‡Øà ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡Æï</button>
                    <div id="paymentMessage" class="message" style="display:none;"></div>
                </form>
            </div>
        </div>
        
        <div id="recordsTab" class="tab-content" style="display:none;">
            <div class="section">
                <h2>‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç</h2>
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="‡Æ§‡Øá‡Æü‡ØÅ...">
                    <button onclick="searchCustomers()">‡Æ§‡Øá‡Æü‡ØÅ</button>
                    <button onclick="resetSearch()">‡ÆÆ‡ØÄ‡Æü‡Øç‡Æü‡ÆÆ‡Øà</button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table id="customerTable">
                        <thead>
                            <tr>
                                <th>‡Æ™‡Æü‡ÆÆ‡Øç</th>
                                <th>‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç</th>
                                <th>‡ÆÖ‡Æö‡Æ≤‡Øç</th>
                                <th>‡Æµ‡Æü‡Øç‡Æü‡Æø</th>
                                <th>‡Æö‡ØÜ‡Æ≤‡ØÅ‡Æ§‡Øç‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ</th>
                                <th>‡ÆÆ‡ØÄ‡Æ§‡Æø</th>
                                <th>‡Æö‡ØÜ‡ÆØ‡Æ≤‡Øç‡Æï‡Æ≥‡Øç</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody">
                        </tbody>
                    </table>
                </div>
                
                <div class="total-summary">
                    <h3>‡Æµ‡Æ£‡Æø‡Æï ‡Æö‡ØÅ‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡ÆÆ‡Øç</h3>
                    <p>‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç‡Æï‡Æ≥‡Øç: <span id="totalCustomers">0</span></p>
                    <p>‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡ÆÖ‡Æö‡Æ≤‡Øç: ‚Çπ<span id="totalPrincipal">0</span></p>
                    <p>‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡Æµ‡Æü‡Øç‡Æü‡Æø: ‚Çπ<span id="totalInterest">0</span></p>
                    <p>‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡ÆÆ‡ØÄ‡Æ§‡Æø: ‚Çπ<span id="totalBalance">0</span></p>
                </div>
            </div>
        </div>
        
        <div id="paymentHistoryModal" class="modal">
            <div class="modal-content">
                <h2 id="modalCustomerName">‡Æ™‡Æ£‡ÆÆ‡Øç ‡Æö‡ØÜ‡Æ≤‡ØÅ‡Æ§‡Øç‡Æ§‡Æø‡ÆØ ‡Æµ‡Æø‡Æµ‡Æ∞‡ÆÆ‡Øç</h2>
                <div id="modalCustomerImageContainer" style="text-align: center; margin-bottom: 10px;"></div>
                <table id="paymentHistoryTable" style="width:100%;">
                    <thead>
                        <tr>
                            <th>‡Æ§‡Øá‡Æ§‡Æø</th>
                            <th>‡Æµ‡Æü‡Øç‡Æü‡Æø</th>
                            <th>‡Æ™‡ØÜ‡Æ±‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ</th>
                            <th>‡ÆÆ‡ØÄ‡Æ§‡Æø</th>
                        </tr>
                    </thead>
                    <tbody id="paymentHistoryBody">
                    </tbody>
                </table>
                <button onclick="closeModal()" style="margin-top: 10px;">‡ÆÆ‡ØÇ‡Æü‡ØÅ</button>
            </div>
        </div>
        
        <div id="deleteModal" class="modal">
            <div class="modal-content">
                <h2>‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øà ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æø‡Æ±‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Ææ?</h2>
                <p id="deleteCustomerText">‡Æá‡Æ®‡Øç‡Æ§ ‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øà ‡Æ®‡Æø‡Æ∞‡Æ®‡Øç‡Æ§‡Æ∞‡ÆÆ‡Ææ‡Æï ‡Æ®‡ØÄ‡Æï‡Øç‡Æï ‡Æµ‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡ØÅ‡Æï‡Æø‡Æ±‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Ææ?</p>
                <div style="margin-top: 10px;">
                    <button onclick="confirmDelete()" class="delete-btn">‡ÆÜ‡ÆÆ‡Øç, ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ</button>
                    <button onclick="cancelDelete()">‡Æá‡Æ≤‡Øç‡Æ≤‡Øà, ‡Æ∞‡Æ§‡Øç‡Æ§‡ØÅ‡Æö‡ØÜ‡ÆØ‡Øç</button>
                </div>
            </div>
        </div>
        
        <!-- Hidden print section -->
        <div id="printSection" style="display: none;"></div>
    </div>

    <script>
        let customers = JSON.parse(localStorage.getItem('interestBusinessCustomers')) || [];
        let payments = JSON.parse(localStorage.getItem('interestBusinessPayments')) || [];
        let customerToDelete = null;
        
        // DOM elements
        const customerForm = document.getElementById('customerForm');
        const paymentForm = document.getElementById('paymentForm');
        const customerSelect = document.getElementById('customerSelect');
        const customerTableBody = document.getElementById('customerTableBody');
        const dueAmountInput = document.getElementById('dueAmount');
        const paidAmountInput = document.getElementById('paidAmount');
        const balanceAmountInput = document.getElementById('balanceAmount');
        const printSection = document.getElementById('printSection');
        const customerImageInput = document.getElementById('customerImage');
        const customerImagePreview = document.getElementById('customerImagePreview');
        const customerSignatureInput = document.getElementById('customerSignature');
        const customerSignaturePreview = document.getElementById('customerSignaturePreview');
        const ownerSignatureInput = document.getElementById('ownerSignature');
        const ownerSignaturePreview = document.getElementById('ownerSignaturePreview');
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Load permanent owner signature if exists
            const permanentOwnerSignature = localStorage.getItem('ownerSignaturePermanent');
            if (permanentOwnerSignature) {
                ownerSignaturePreview.src = permanentOwnerSignature;
                ownerSignaturePreview.style.display = 'block';
            }
            
            renderCustomerSelect();
            renderCustomerTable();
            updateSummary();
            
            // Set default dates to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('paymentDate').value = today;
            
            // Event listeners
            customerSelect.addEventListener('change', updatePaymentAmounts);
            paidAmountInput.addEventListener('input', updateBalanceAmount);
        });
        
        // Tab navigation
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabId).style.display = 'block';
            event.currentTarget.classList.add('active');
        }
        
        // Image preview functionality
        customerImageInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    customerImagePreview.src = e.target.result;
                    customerImagePreview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });
        
        // Customer signature preview
        customerSignatureInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    customerSignaturePreview.src = e.target.result;
                    customerSignaturePreview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });
        
        // Owner signature preview and permanent storage
        ownerSignatureInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    ownerSignaturePreview.src = e.target.result;
                    ownerSignaturePreview.style.display = 'block';
                    localStorage.setItem('ownerSignaturePermanent', e.target.result);
                }
                reader.readAsDataURL(file);
            }
        });
        
        // Calculate monthly interest for a customer
        function calculateMonthlyInterest(customer) {
            return customer.principal * (customer.rate / 100);
        }
        
        // Update payment amounts when customer is selected
        function updatePaymentAmounts() {
            const customerId = customerSelect.value;
            if (customerId) {
                const customer = customers.find(c => c.id === customerId);
                if (customer) {
                    const interestAmount = calculateMonthlyInterest(customer);
                    dueAmountInput.value = interestAmount.toFixed(2);
                    paidAmountInput.value = '';
                    balanceAmountInput.value = interestAmount.toFixed(2);
                }
            }
        }
        
        // Update balance amount when paid amount changes
        function updateBalanceAmount() {
            const dueAmount = parseFloat(dueAmountInput.value) || 0;
            const paidAmount = parseFloat(paidAmountInput.value) || 0;
            const balance = dueAmount - paidAmount;
            balanceAmountInput.value = balance.toFixed(2);
        }
        
        // Add new customer
        customerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const permanentOwnerSignature = localStorage.getItem('ownerSignaturePermanent');
            
            const customer = {
                id: Date.now().toString(),
                name: document.getElementById('customerName').value,
                phone: document.getElementById('phoneNumber').value,
                aadhar: document.getElementById('aadharNumber').value,
                principal: parseFloat(document.getElementById('principalAmount').value),
                rate: parseFloat(document.getElementById('interestRate').value),
                startDate: document.getElementById('startDate').value,
                image: customerImagePreview.src || '',
                signature_customer: customerSignaturePreview.src || '',
                signature: permanentOwnerSignature || ownerSignaturePreview.src || ''
            };
            
            customers.push(customer);
            saveData();
            
            // Reset form
            customerForm.reset();
            customerImagePreview.src = '';
            customerImagePreview.style.display = 'none';
            customerSignaturePreview.src = '';
            customerSignaturePreview.style.display = 'none';
            document.getElementById('startDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('interestRate').value = '3';
            
            showMessage('formMessage', '‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Ææ‡Æ∞‡Øç!', 'success');
            
            renderCustomerSelect();
            renderCustomerTable();
            updateSummary();
        });
        
        // Record payment
        paymentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const customerId = customerSelect.value;
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            const payment = {
                id: Date.now().toString(),
                customerId: customerId,
                date: document.getElementById('paymentDate').value,
                dueAmount: parseFloat(dueAmountInput.value),
                paidAmount: parseFloat(paidAmountInput.value),
                balance: parseFloat(balanceAmountInput.value),
                notes: document.getElementById('paymentNotes').value
            };
            
            payments.push(payment);
            saveData();
            
            // Send SMS to customer if phone exists
            if (customer.phone && customer.phone.length === 10) {
                sendSMSNotification(customer.phone, customer.name, payment.paidAmount, payment.balance);
            }
            
            // Reset form
            paymentForm.reset();
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            dueAmountInput.value = '';
            paidAmountInput.value = '';
            balanceAmountInput.value = '';
            
            showMessage('paymentMessage', '‡Æ™‡Æ£‡ÆÆ‡Øç ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ!', 'success');
            
            renderCustomerTable();
            updateSummary();
        });
        
        // Simulate SMS notification (in a real app, call an SMS API)
        function sendSMSNotification(phoneNumber, customerName, paidAmount, balance) {
            const message = `ANNAMALAIYAR FINANCE: ‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç ${customerName}, ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‚Çπ${paidAmount.toFixed(2)} ‡Æµ‡Æü‡Øç‡Æü‡Æø‡Æ§‡Øç ‡Æ§‡Øä‡Æï‡Øà ‡Æ™‡ØÜ‡Æ±‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ. ‡ÆÆ‡ØÄ‡Æ§‡Æø: ‚Çπ${balance.toFixed(2)}. ‡Æ®‡Æ©‡Øç‡Æ±‡Æø!`;
            console.log(`SMS sent to ${phoneNumber}: ${message}`);
        }
        
        // Prepare print content
        function preparePrintContent(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            const customerPayments = payments.filter(p => p.customerId === customerId)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const totalPaid = customerPayments.reduce((sum, p) => sum + p.paidAmount, 0);
            const totalBalance = customerPayments.reduce((sum, p) => sum + p.balance, 0);
            const monthlyInterest = calculateMonthlyInterest(customer);
            
            const formattedAadhar = customer.aadhar 
                ? `${customer.aadhar.substring(0, 4)}-${customer.aadhar.substring(4, 8)}-${customer.aadhar.substring(8, 12)}` 
                : '-';
            
            let printHTML = `
                <div style="text-align: center; margin-bottom: 10px;">
                    <h1 style="margin-bottom: 5px; font-size: 16px;">ANNAMALAIYAR FINANCE</h1>
                    <p style="font-size: 10px; margin-top: 5px;">‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æ§‡Øá‡Æ§‡Æø: ${formatDate(new Date())}</p>
                </div>
                
                <div style="text-align: center; margin-bottom: 10px;">
                    ${customer.image ? `<img src="${customer.image}" class="print-image" alt="Customer Image">` : ''}
                </div>
                
                <h2 style="border-bottom: 1px solid #ddd; padding-bottom: 3px; font-size: 14px;">‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç ‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç</h2>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 10px;">
                    <tr>
                        <td style="font-weight: bold; padding: 3px; border: 1px solid #ddd; width: 30%;">‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç</td>
                        <td style="padding: 3px; border: 1px solid #ddd; width: 70%;">${customer.name}</td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold; padding: 3px; border: 1px solid #ddd;">‡Æ§‡Øä‡Æ≤‡Øà‡Æ™‡Øá‡Æö‡Æø</td>
                        <td style="padding: 3px; border: 1px solid #ddd;">${customer.phone || '-'}</td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold; padding: 3px; border: 1px solid #ddd;">‡ÆÜ‡Æ§‡Ææ‡Æ∞‡Øç</td>
                        <td style="padding: 3px; border: 1px solid #ddd;">${formattedAadhar}</td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold; padding: 3px; border: 1px solid #ddd;">‡ÆÖ‡Æö‡Æ≤‡Øç ‡Æ§‡Øä‡Æï‡Øà</td>
                        <td style="padding: 3px; border: 1px solid #ddd;">‚Çπ${customer.principal.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold; padding: 3px; border: 1px solid #ddd;">‡Æµ‡Æü‡Øç‡Æü‡Æø ‡Æµ‡Æø‡Æï‡Æø‡Æ§‡ÆÆ‡Øç</td>
                        <td style="padding: 3px; border: 1px solid #ddd;">${customer.rate}%</td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold; padding: 3px; border: 1px solid #ddd;">‡ÆÆ‡Ææ‡Æ§‡Ææ‡Æ®‡Øç‡Æ§‡Æø‡Æ∞ ‡Æµ‡Æü‡Øç‡Æü‡Æø ‡Æ§‡Øä‡Æï‡Øà</td>
                        <td style="padding: 3px; border: 1px solid #ddd;">‚Çπ${monthlyInterest.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold; padding: 3px; border: 1px solid #ddd;">‡Æ§‡Øä‡Æü‡Æï‡Øç‡Æï ‡Æ§‡Øá‡Æ§‡Æø</td>
                        <td style="padding: 3px; border: 1px solid #ddd;">${formatDate(new Date(customer.startDate))}</td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold; padding: 3px; border: 1px solid #ddd;">‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§‡ÆÆ‡Øç ‡Æö‡ØÜ‡Æ≤‡ØÅ‡Æ§‡Øç‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ</td>
                        <td style="padding: 3px; border: 1px solid #ddd;">‚Çπ${totalPaid.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold; padding: 3px; border: 1px solid #ddd;">‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§‡ÆÆ‡Øç ‡ÆÆ‡ØÄ‡Æ§‡Æø</td>
                        <td style="padding: 3px; border: 1px solid #ddd;">‚Çπ${totalBalance.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold; padding: 3px; border: 1px solid #ddd;">‡Æï‡Æü‡Øà‡Æö‡Æø ‡Æ™‡Æ£‡ÆÆ‡Øç ‡Æö‡ØÜ‡Æ≤‡ØÅ‡Æ§‡Øç‡Æ§‡Æø‡ÆØ ‡Æ§‡Øá‡Æ§‡Æø</td>
                        <td style="padding: 3px; border: 1px solid #ddd;">${customerPayments.length > 0 ? formatDate(new Date(customerPayments[customerPayments.length - 1].date)) : '‡Æá‡Æ≤‡Øç‡Æ≤‡Øà'}</td>
                    </tr>
                </table>
            `;
            
            if (customerPayments.length > 0) {
                printHTML += `
                    <h2 style="border-bottom: 1px solid #ddd; padding-bottom: 3px; margin-top: 10px; font-size: 14px;">‡Æ™‡Æ£‡ÆÆ‡Øç ‡Æö‡ØÜ‡Æ≤‡ØÅ‡Æ§‡Øç‡Æ§‡Æø‡ÆØ ‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡ØÅ</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 10px;">
                        <thead>
                            <tr>
                                <th style="background-color: #3498db; color: white; padding: 5px; border: 1px solid #ddd;">‡Æ§‡Øá‡Æ§‡Æø</th>
                                <th style="background-color: #3498db; color: white; padding: 5px; border: 1px solid #ddd;">‡Æµ‡Æü‡Øç‡Æü‡Æø ‡Æ§‡Øä‡Æï‡Øà</th>
                                <th style="background-color: #3498db; color: white; padding: 5px; border: 1px solid #ddd;">‡Æ™‡ØÜ‡Æ±‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ</th>
                                <th style="background-color: #3498db; color: white; padding: 5px; border: 1px solid #ddd;">‡ÆÆ‡ØÄ‡Æ§‡Æø</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                customerPayments.forEach(payment => {
                    printHTML += `
                        <tr>
                            <td style="padding: 5px; border: 1px solid #ddd;">${formatDate(new Date(payment.date))}</td>
                            <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">‚Çπ${payment.dueAmount.toFixed(2)}</td>
                            <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">‚Çπ${payment.paidAmount.toFixed(2)}</td>
                            <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">‚Çπ${payment.balance.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                printHTML += `
                        </tbody>
                    </table>
                `;
            }
            
            // Add signature section
            printHTML += `
                <div class="signature-container">
                    <div class="signature-box">
                        ${customer.signature_customer ? `<img src="${customer.signature_customer}" class="print-signature" alt="Customer Signature">` : '<div class="signature-line"></div>'}
                        <p class="signature-title">‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç ‡Æï‡Øà‡ÆØ‡Øä‡Æ™‡Øç‡Æ™‡ÆÆ‡Øç</p>
                    </div>
                    <div class="signature-box">
                        ${customer.signature ? `<img src="${customer.signature}" class="print-signature" alt="Owner Signature">` : '<div class="signature-line"></div>'}
                        <p class="signature-title">‡Æâ‡Æ∞‡Æø‡ÆÆ‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç ‡Æï‡Øà‡ÆØ‡Øä‡Æ™‡Øç‡Æ™‡ÆÆ‡Øç</p>
                    </div>
                </div>
                
                <div class="print-footer">
                    <p>ANNAMALAIYAR FINANCE</p>
                    <p>‡Æ™‡Æï‡Øç‡Æï‡ÆÆ‡Øç: <span class="page-number"></span></p>
                </div>
            `;
            
            return printHTML;
        }
        
        // Format date for display
        function formatDate(date) {
            if (!date || isNaN(new Date(date).getTime())) return '';
            const options = { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit'
            };
            return new Date(date).toLocaleDateString('en-IN', options);
        }
        
        // Print customer details
        function printCustomerDetails(customerId) {
            const printContent = preparePrintContent(customerId);
            if (!printContent) return;
            
            printSection.innerHTML = printContent;
            printSection.style.display = 'block';
            
            window.print();
            
            setTimeout(() => {
                printSection.style.display = 'none';
                printSection.innerHTML = '';
            }, 500);
        }
        
        // Render customer dropdown
        function renderCustomerSelect() {
            customerSelect.innerHTML = '<option value="">-- ‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øà ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç --</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name} (‚Çπ${customer.principal.toFixed(2)})`;
                customerSelect.appendChild(option);
            });
        }
        
        // Render customer table
        function renderCustomerTable(filteredCustomers = null) {
            const displayCustomers = filteredCustomers || customers;
            customerTableBody.innerHTML = '';
            
            displayCustomers.forEach(customer => {
                const customerPayments = payments.filter(p => p.customerId === customer.id);
                const totalPaid = customerPayments.reduce((sum, p) => sum + p.paidAmount, 0);
                const totalBalance = customerPayments.reduce((sum, p) => sum + p.balance, 0);
                const lastPayment = customerPayments.length > 0 
                    ? formatDate(new Date(customerPayments[customerPayments.length - 1].date))
                    : '‡Æá‡Æ≤‡Øç‡Æ≤‡Øà';
                const monthlyInterest = calculateMonthlyInterest(customer);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.image ? `<img src="${customer.image}" class="customer-image" alt="${customer.name}">` : '-'}</td>
                    <td class="nowrap">${customer.name}</td>
                    <td class="nowrap">‚Çπ${customer.principal.toFixed(2)}</td>
                    <td>${customer.rate}%</td>
                    <td class="nowrap">‚Çπ${totalPaid.toFixed(2)}</td>
                    <td class="nowrap balance">‚Çπ${totalBalance.toFixed(2)}</td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="viewPaymentHistory('${customer.id}', '${customer.name}', '${customer.image || ''}')">‡Æ™‡Æ£‡ÆÆ‡Øç</button>
                            <button onclick="printCustomerDetails('${customer.id}')" class="print-btn">‡ÆÖ‡Æö‡Øç‡Æö‡Æø‡Æü‡ØÅ</button>
                            <button onclick="showDeleteModal('${customer.id}', '${customer.name}')" class="delete-btn">‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ</button>
                        </div>
                    </td>
                `;
                customerTableBody.appendChild(row);
            });
        }
        
        // Update summary statistics
        function updateSummary() {
            document.getElementById('totalCustomers').textContent = customers.length;
            
            const totalPrincipal = customers.reduce((sum, c) => sum + c.principal, 0);
            document.getElementById('totalPrincipal').textContent = totalPrincipal.toFixed(2);
            
            const totalInterest = payments.reduce((sum, p) => sum + p.paidAmount, 0);
            document.getElementById('totalInterest').textContent = totalInterest.toFixed(2);
            
            const totalBalance = payments.reduce((sum, p) => sum + p.balance, 0);
            document.getElementById('totalBalance').textContent = totalBalance.toFixed(2);
        }
        
        // View payment history in modal
        function viewPaymentHistory(customerId, customerName, customerImage) {
            const modal = document.getElementById('paymentHistoryModal');
            const customerPayments = payments.filter(p => p.customerId === customerId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            document.getElementById('modalCustomerName').textContent = `${customerName} - ‡Æ™‡Æ£‡ÆÆ‡Øç ‡Æö‡ØÜ‡Æ≤‡ØÅ‡Æ§‡Øç‡Æ§‡Æø‡ÆØ ‡Æµ‡Æø‡Æµ‡Æ∞‡ÆÆ‡Øç`;
            
            const imageContainer = document.getElementById('modalCustomerImageContainer');
            imageContainer.innerHTML = customerImage 
                ? `<img src="${customerImage}" class="customer-image" alt="${customerName}">`
                : '';
            
            const paymentHistoryBody = document.getElementById('paymentHistoryBody');
            paymentHistoryBody.innerHTML = '';
            
            if (customerPayments.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="4" style="text-align:center;">‡Æ™‡Æ£‡ÆÆ‡Øç ‡Æö‡ØÜ‡Æ≤‡ØÅ‡Æ§‡Øç‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ ‡Æé‡Æ§‡ØÅ‡Æµ‡ØÅ‡ÆÆ‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà</td>';
                paymentHistoryBody.appendChild(row);
            } else {
                customerPayments.forEach(payment => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="nowrap">${formatDate(new Date(payment.date))}</td>
                        <td class="nowrap">‚Çπ${payment.dueAmount.toFixed(2)}</td>
                        <td class="nowrap">‚Çπ${payment.paidAmount.toFixed(2)}</td>
                        <td class="nowrap balance">‚Çπ${payment.balance.toFixed(2)}</td>
                    `;
                    paymentHistoryBody.appendChild(row);
                });
            }
            
            modal.style.display = 'flex';
        }
        
        // Show delete confirmation modal
        function showDeleteModal(customerId, customerName) {
            customerToDelete = customerId;
            document.getElementById('deleteCustomerText').textContent = 
                `‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç "${customerName}" ‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øà ‡Æ®‡Æø‡Æ∞‡Æ®‡Øç‡Æ§‡Æ∞‡ÆÆ‡Ææ‡Æï ‡Æ®‡ØÄ‡Æï‡Øç‡Æï ‡Æµ‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡ØÅ‡Æï‡Æø‡Æ±‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Ææ?`;
            document.getElementById('deleteModal').style.display = 'flex';
        }
        
        // Confirm customer deletion
        function confirmDelete() {
            if (customerToDelete) {
                customers = customers.filter(c => c.id !== customerToDelete);
                payments = payments.filter(p => p.customerId !== customerToDelete);
                saveData();
                
                renderCustomerSelect();
                renderCustomerTable();
                updateSummary();
                
                showMessage('formMessage', '‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Ææ‡Æ∞‡Øç!', 'success');
            }
            closeModal();
            customerToDelete = null;
        }
        
        // Cancel deletion
        function cancelDelete() {
            closeModal();
            customerToDelete = null;
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('paymentHistoryModal').style.display = 'none';
            document.getElementById('deleteModal').style.display = 'none';
        }
        
        // Search customers
        function searchCustomers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (!searchTerm) return;
            
            const filtered = customers.filter(c => 
                c.name.toLowerCase().includes(searchTerm) || 
                (c.phone && c.phone.includes(searchTerm)) ||
                (c.aadhar && c.aadhar.includes(searchTerm)));
            
            renderCustomerTable(filtered);
        }
        
        // Reset search
        function resetSearch() {
            document.getElementById('searchInput').value = '';
            renderCustomerTable();
        }
        
        // Show status message
        function showMessage(elementId, text, type) {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.className = 'message ' + type;
            element.style.display = 'block';
            setTimeout(() => element.style.display = 'none', 3000);
        }
        
        // Save data to localStorage
        function saveData() {
            localStorage.setItem('interestBusinessCustomers', JSON.stringify(customers));
            localStorage.setItem('interestBusinessPayments', JSON.stringify(payments));
        }
    </script>
</body>
</html>